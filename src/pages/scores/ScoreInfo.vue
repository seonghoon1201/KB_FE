<!-- src/pages/ScoreInfoPage.vue -->
<template>
    <div class="flex flex-col min-h-screen bg-white">
        <BackHeader title="ë‚´ ì²­ì•½ ì •ë³´" />
        <div class="mt-16">
            <ul class="flex-1 divide-y divide-gray-200">
                <!-- ìƒë…„ì›”ì¼ -->
                <li class="flex justify-between items-center px-4 py-5">
                    <div class="flex items-center gap-3">
                        <CalendarIcon class="w-6 h-6 text-gray-500" />
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500">ìƒë…„ì›”ì¼</p>
                            <p class="text-base font-semibold text-gray-800">
                                {{ formattedBirth }} (ë§Œ {{ age }}ì„¸)
                            </p>
                        </div>
                    </div>
                </li>

                <!-- ë¬´ì£¼íƒ ê¸°ê°„ -->
                <li class="flex justify-between items-center px-4 py-5">
                    <div class="flex items-center gap-3">
                        <HomeIcon class="w-6 h-6 text-gray-500" />
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500">ë¬´ì£¼íƒ ê¸°ê°„</p>
                            <p class="text-base font-semibold text-gray-800">
                                {{ store.noHousePeriod }}ë…„
                            </p>
                        </div>
                    </div>
                </li>

                <!-- ê±°ì£¼ ì‹œì‘ ì—°ì›” -->
                <li class="flex justify-between items-center px-4 py-5">
                    <div class="flex items-center gap-3">
                        <MapPinIcon class="w-6 h-6 text-gray-500" />
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500">ê±°ì£¼ ì‹œì‘ ì—°ì›”</p>
                            <p class="text-base font-semibold text-gray-800">
                                {{ formattedResidenceDate }}
                            </p>
                        </div>
                    </div>
                    <button
                        @click="pushEdit(6)"
                        class="px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full hover:bg-gray-200 transition"
                    >
                        ìˆ˜ì •
                    </button>
                </li>

                <!-- ì„¸ëŒ€ì£¼ ì—¬ë¶€ -->
                <li class="flex justify-between items-center px-4 py-5">
                    <div class="flex items-center gap-3">
                        <HomeIcon class="w-6 h-6 text-gray-500" />
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500">ì„¸ëŒ€ì£¼ ì—¬ë¶€</p>
                            <p class="text-base font-semibold text-gray-800">{{ headLabel }}</p>
                        </div>
                    </div>
                    <button
                        @click="pushEdit(3)"
                        class="px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full hover:bg-gray-200 transition"
                    >
                        ìˆ˜ì •
                    </button>
                </li>

                <!-- ì£¼íƒ ì†Œìœ  ì—¬ë¶€ -->
                <li class="flex justify-between items-center px-4 py-5">
                    <div class="flex items-center gap-3">
                        <HomeIcon class="w-6 h-6 text-gray-500" />
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500">ì£¼íƒ ì†Œìœ  ìœ ë¬´</p>
                            <p class="text-base font-semibold text-gray-800">{{ ownerLabel }}</p>
                        </div>
                    </div>
                    <button
                        @click="pushEdit(1)"
                        class="px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full hover:bg-gray-200 transition"
                    >
                        ìˆ˜ì •
                    </button>
                </li>

                <!-- ì£¼íƒ ì²˜ë¶„ ì—¬ë¶€ -->
                <li class="flex justify-between items-center px-4 py-5">
                    <div class="flex items-center gap-3">
                        <TrashIcon class="w-6 h-6 text-gray-500" />
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500">ì£¼íƒ ì²˜ë¶„ ìœ ë¬´</p>
                            <p class="text-base font-semibold text-gray-800">{{ disposalLabel }}</p>
                        </div>
                    </div>
                    <button
                        @click="pushEdit(2)"
                        class="px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full hover:bg-gray-200 transition"
                    >
                        ìˆ˜ì •
                    </button>
                </li>

                <!-- í˜¼ì¸ ì—¬ë¶€ -->
                <li class="flex justify-between items-center px-4 py-5">
                    <div class="flex items-center gap-3">
                        <UserCheckIcon class="w-6 h-6 text-gray-500" />
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500">í˜¼ì¸ ì—¬ë¶€</p>
                            <p class="text-base font-semibold text-gray-800">{{ maritalLabel }}</p>
                        </div>
                    </div>
                    <button
                        @click="pushEdit(4)"
                        class="px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full hover:bg-gray-200 transition"
                    >
                        ìˆ˜ì •
                    </button>
                </li>

                <!-- ë¶€ì–‘ê°€ì¡± ìˆ˜ -->
                <li class="flex justify-between items-center px-4 py-5">
                    <div class="flex items-center gap-3">
                        <UsersIcon class="w-6 h-6 text-gray-500" />
                        <div class="space-y-1">
                            <p class="text-xs text-gray-500">ë¶€ì–‘ê°€ì¡± ìˆ˜</p>
                            <p class="text-base font-semibold text-gray-800">
                                {{ store.dependentsNm }}ëª…
                            </p>
                        </div>
                    </div>
                    <button
                        @click="pushEdit(5)"
                        class="px-3 py-1 bg-gray-100 text-gray-600 text-sm rounded-full hover:bg-gray-200 transition"
                    >
                        ìˆ˜ì •
                    </button>
                </li>
            </ul>

            <!-- í™•ì¸ ë²„íŠ¼: ì¬ê³„ì‚° í›„ ê²°ê³¼ í˜ì´ì§€ë¡œ -->
            <div class="px-4 pt-5">
                <button
                    @click="confirmInfo"
                    class="w-full py-4 bg-blue-500 text-white font-bold rounded-full shadow-lg"
                >
                    í™•ì¸
                </button>
            </div>
        </div>
    </div>
</template>

<script setup>
import { onMounted, computed } from 'vue'
import { useRouter } from 'vue-router'
import { useScoreStore } from '@/stores/scoreStore'
import { useUserStore } from '@/stores/user'
import BackHeader from '@/components/common/BackHeader.vue'
import {
    Calendar as CalendarIcon,
    MapPin as MapPinIcon,
    Home as HomeIcon,
    Users as UsersIcon,
    UserCheck as UserCheckIcon,
    Trash2 as TrashIcon,
} from 'lucide-vue-next'

const router = useRouter()
const store = useScoreStore()
const userStore = useUserStore()

// í˜ì´ì§€ ì§„ì… ì‹œ ìë™ ì¬ê³„ì‚°
onMounted(async () => {
    try {
        const res = await store.fetchScoreFromServer() // GET /ga-score
        const data = await store.calculateScore()
        console.log('[ScoreInfoPage] calculateScore ì™„ë£Œ:', data)
    } catch (e) {
        console.error('ì´ˆê¸° ì ìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e)
    }
})

// ìˆœì„œ: ë¡œì»¬ ì…ë ¥ê°’ ë¨¼ì €, ì—†ìœ¼ë©´ API ê²°ê³¼
const rawResidence = computed(() => store.residenceStartDate || store.result.residence_start_date)
const formattedResidenceDate = computed(() => {
    if (!rawResidence.value) return ''
    const [y, m] = rawResidence.value.split('-')
    return `${y}. ${m.padStart(2, '0')}`
})

// ìƒë…„ì›”ì¼ í¬ë§·
const formattedBirth = computed(() => {
    const d = new Date(userStore.birthDate)
    return `${d.getFullYear()}. ${String(d.getMonth() + 1).padStart(2, '0')}. ${String(
        d.getDate(),
    ).padStart(2, '0')}`
})

// ë‚˜ì´ ê³„ì‚°
const age = computed(() =>
    Math.floor((Date.now() - new Date(userStore.birthDate)) / (1000 * 60 * 60 * 24 * 365)),
)

// ë ˆì´ë¸”
const headLabel = computed(() => (store.headOfHousehold === 1 ? 'ì„¸ëŒ€ì£¼' : 'ì„¸ëŒ€ì›'))
const ownerLabel = computed(() => (store.houseOwner === 1 ? 'ì†Œìœ  ì¤‘' : 'ë¬´ì£¼íƒ'))
const disposalLabel = computed(() =>
    store.houseDisposal === 1 ? `ì²˜ë¶„ / ${store.disposalDate}` : 'ë¯¸ì²˜ë¶„',
)
const maritalLabel = computed(() =>
    store.maritalStatus === 1 ? `ê¸°í˜¼ / ${store.weddingDate}` : 'ë¯¸í˜¼',
)

// ìˆ˜ì • í˜ì´ì§€ ì´ë™
function pushEdit(step) {
    router.push(`/score/edit/step${step}`)
}

// í™•ì¸ ë²„íŠ¼ (ì¬ê³„ì‚° í›„ ê²°ê³¼ í˜ì´ì§€)
async function confirmInfo() {
    const data = await store.calculateScore()
    console.log('[âœ… í™•ì¸ ë²„íŠ¼ í›„ ì ìˆ˜ ê²°ê³¼]', data)
    console.log('ğŸ‘‰ dependents_score:', data?.dependents_score)
    router.push('/score/result')
}
</script>
